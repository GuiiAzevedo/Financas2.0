<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#5a67d8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Finan√ßas Fam√≠lia</title>

    <!-- LINK PARA O SEU √çCONE E MANIFESTO -->
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="manifest" href="manifest.json">

    <style>
        :root {
            --bg-body: #f4f6f8;
            --bg-card: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --primary: #5a67d8;
            --primary-hover: #4c51bf;
            --success: #48bb78;
            --danger: #f56565;
            --warning: #ed8936;
            --info: #4299e1;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: var(--font-family); background-color: var(--bg-body); color: var(--text-primary); line-height: 1.5; height: 100vh; display: flex; overflow: hidden; }

        /* Layout */
        .sidebar { width: 260px; background: var(--bg-card); border-right: 1px solid var(--border); padding: 2rem 1.5rem; display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.3s ease; z-index: 100; }
        .main-content { flex: 1; overflow-y: auto; padding: 2rem; position: relative; scroll-behavior: smooth; }

        /* Nav */
        .brand { font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-bottom: 2rem; display: flex; align-items: center; gap: 10px; }
        .nav-links { list-style: none; display: flex; flex-direction: column; gap: 0.5rem; }
        .nav-item { padding: 0.75rem 1rem; border-radius: var(--radius); cursor: pointer; transition: all 0.2s; color: var(--text-secondary); font-weight: 500; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { background-color: #f7fafc; color: var(--primary); }
        .nav-item.active { background-color: #ebf4ff; color: var(--primary); }

        /* Components */
        .btn { padding: 0.75rem 1.5rem; border-radius: var(--radius); border: none; cursor: pointer; font-weight: 600; transition: transform 0.1s, opacity 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); }
        .btn-sm { padding: 0.4rem 0.6rem; font-size: 0.85rem; margin-left: 5px; }
        .card { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1.5rem; margin-bottom: 1.5rem; }

        /* Dashboard */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card h3 { font-size: 0.875rem; color: var(--text-secondary); font-weight: 500; margin-bottom: 0.5rem; }
        .stat-card .value { font-size: 1.75rem; font-weight: 700; }
        .text-success { color: var(--success); } .text-danger { color: var(--danger); } .text-primary { color: var(--primary); }

        /* Lists */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #edf2f7; background: white; }
        .item-info h4 { font-size: 1rem; margin-bottom: 0.2rem; }
        .item-info p { font-size: 0.85rem; color: var(--text-secondary); }
        .tag { font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; background: #edf2f7; color: var(--text-secondary); margin-left: 8px; }
        .action-buttons { display: flex; gap: 5px; }

        /* Cards UI */
        .credit-card-ui { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 16px; margin-bottom: 1rem; position: relative; overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .progress-bar-bg { background: rgba(255,255,255,0.3); height: 8px; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .progress-bar-fill { background: white; height: 100%; border-radius: 4px; width: 0%; transition: width 0.5s ease; }

        /* Login */
        #auth-overlay { background: var(--bg-body); z-index: 2000; display: flex; align-items: center; justify-content: center; position: fixed; top:0; left:0; width:100%; height:100%; }
        .auth-box { background: white; padding: 2.5rem; border-radius: var(--radius); box-shadow: var(--shadow); width: 100%; max-width: 400px; text-align: center; }
        .auth-tabs { display: flex; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); }
        .auth-tab { flex: 1; padding: 0.5rem; cursor: pointer; color: var(--text-secondary); }
        .auth-tab.active { border-bottom: 2px solid var(--primary); color: var(--primary); font-weight: bold; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal { background: white; width: 100%; max-width: 500px; border-radius: var(--radius); padding: 2rem; transform: translateY(20px); transition: transform 0.3s; max-height: 90vh; overflow-y: auto;}
        .modal-overlay.open .modal { transform: translateY(0); }
        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500; }
        .form-control { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 1rem; }
        .radio-group { display: flex; gap: 1rem; }
        .radio-option { flex: 1; padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; text-align: center; }
        .radio-option.selected { border-color: var(--primary); background: #ebf4ff; color: var(--primary); }

        /* Toast */
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: white; border-left: 4px solid var(--primary); padding: 1rem; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); min-width: 250px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .hidden { display: none !important; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .empty-state { text-align: center; padding: 3rem; color: var(--text-secondary); }
        
        /* Loading */
        #loading-overlay { position: fixed; inset: 0; background: white; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mobile Adjustments */
        .mobile-menu-btn { display: none; position: fixed; top: 15px; right: 15px; z-index: 200; background: white; border-radius: 50%; width: 40px; height: 40px; box-shadow: var(--shadow); border: none; font-size: 1.2rem; align-items: center; justify-content: center; cursor: pointer; }

        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; min-height: 100vh; }
            .sidebar { 
                position: fixed; height: 100%; left: -260px; 
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }
            .sidebar.open { transform: translateX(260px); left: -260px; }
            .mobile-menu-btn { display: flex; }
            .nav-links { flex-direction: column; overflow-x: visible; padding-bottom: 5px; }
            .main-content { padding: 5rem 1rem 1rem 1rem; }
            .summary-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- LOADING -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; color: var(--text-secondary);">Conectando ao Firebase...</p>
    </div>

    <!-- MOBILE MENU BUTTON -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <!-- AUTH SCREEN -->
    <div id="auth-overlay" class="modal-overlay open">
        <div class="auth-box">
            <!-- √çcone grande de introdu√ß√£o -->
            <img src="icon.png" style="width: 80px; height: 80px; border-radius: 20px; margin-bottom: 1rem; box-shadow: var(--shadow);" alt="Logo">
            
            <h1 style="color: var(--primary); margin-bottom: 0.5rem;">Finan√ßas Fam√≠lia</h1>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Controle conjunto em tempo real.</p>
            
            <div class="auth-tabs">
                <div class="auth-tab active" id="tab-login" onclick="switchAuthTab('login')">Entrar</div>
                <div class="auth-tab" id="tab-register" onclick="switchAuthTab('register')">Criar Conta</div>
            </div>

            <form id="auth-form" onsubmit="handleAuth(event)">
                <div class="form-group">
                    <input type="email" id="auth-email" class="form-control" placeholder="Seu Email" required autocomplete="email">
                </div>
                <div class="form-group">
                    <input type="password" id="auth-pass" class="form-control" placeholder="Senha" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Acessar Sistema</button>
            </form>
            <div id="auth-error" style="color: var(--danger); margin-top: 15px; font-size: 0.9rem; min-height: 1.2em;"></div>
        </div>
    </div>

    <!-- APP LAYOUT -->
    <nav class="sidebar" id="app-sidebar">
        <div>
            <div class="brand">Finan√ßas</div>
            <div style="margin-bottom: 1rem; font-size: 0.9rem; color: var(--text-secondary); padding: 0.5rem; background: #f7fafc; border-radius: 8px;">
                <div style="font-weight:bold; color:var(--primary);" id="display-email"></div>
                <div style="font-size:0.75rem; opacity:0.7;">Logado</div>
            </div>
            <ul class="nav-links">
                <li class="nav-item active" onclick="showSection('dashboard', this)"><span>üìä</span> Dashboard</li>
                <li class="nav-item" onclick="showSection('transactions', this)"><span>üí∏</span> Transa√ß√µes</li>
                <li class="nav-item" onclick="showSection('cards', this)"><span>üí≥</span> Cart√µes</li>
                <li class="nav-item" onclick="showSection('logs', this)"><span>üìú</span> Logs</li>
            </ul>
        </div>
        <button class="btn btn-outline btn-sm" onclick="logout()" style="width:100%">Sair</button>
    </nav>

    <main class="main-content hidden" id="app-main">
        <!-- Dashboard -->
        <section id="dashboard" class="view-section">
            <div class="flex-between">
                <h2>Vis√£o Geral</h2>
                <button class="btn btn-primary" onclick="openTransactionModal()">+ Nova</button>
            </div>
            <div class="summary-grid">
                <div class="card stat-card"><h3>Saldo Atual</h3><div class="value text-primary" id="total-balance">R$ 0,00</div></div>
                <div class="card stat-card"><h3>Entradas</h3><div class="value text-success" id="total-income">R$ 0,00</div></div>
                <div class="card stat-card"><h3>Sa√≠das</h3><div class="value text-danger" id="total-expense">R$ 0,00</div></div>
            </div>
            <div class="card">
                <h3>√öltimas Transa√ß√µes</h3>
                <div id="recent-transactions-list" class="transaction-list"></div>
            </div>
        </section>

        <!-- Transactions -->
        <section id="transactions" class="view-section hidden">
            <div class="flex-between">
                <h2>Minhas Transa√ß√µes</h2>
                <button class="btn btn-primary" onclick="openTransactionModal()">+ Adicionar</button>
            </div>
            <div class="card">
                <input type="text" id="search-input" class="form-control" placeholder="üîç Buscar..." onkeyup="renderTransactionsList()">
                <div id="all-transactions-list" class="transaction-list" style="margin-top: 1rem;"></div>
            </div>
        </section>

        <!-- Cards -->
        <section id="cards" class="view-section hidden">
            <div class="flex-between">
                <h2>Meus Cart√µes</h2>
                <button class="btn btn-primary" onclick="openCardModal()">+ Novo Cart√£o</button>
            </div>
            <div id="cards-container" class="card-list"></div>
        </section>

        <!-- Logs -->
        <section id="logs" class="view-section hidden">
            <div class="flex-between"><h2>Log de Auditoria</h2><button class="btn btn-outline btn-sm" onclick="clearLogs()">Limpar Logs</button></div>
            <div class="card">
                <div id="logs-list" style="display: flex; flex-direction: column; gap: 1rem; border-left: 2px solid var(--border); padding-left: 20px; margin-left: 10px;"></div>
            </div>
        </section>
    </main>

    <!-- MODALS -->
    <!-- Transaction Modal -->
    <div class="modal-overlay" id="transaction-modal">
        <div class="modal">
            <div class="flex-between">
                <h3 id="t-modal-title">Nova Transa√ß√£o</h3>
                <button class="btn btn-sm btn-outline" onclick="closeModals()">‚úï</button>
            </div>
            <form id="transaction-form">
                <input type="hidden" id="t-id">
                <div class="form-group">
                    <label>Tipo</label>
                    <div class="radio-group">
                        <div class="radio-option selected" onclick="selectType('income', this)" id="opt-income">Entrada</div>
                        <div class="radio-option" onclick="selectType('expense', this)" id="opt-expense">Sa√≠da</div>
                    </div>
                </div>
                <div class="form-group"><label>Descri√ß√£o</label><input type="text" id="t-desc" class="form-control" required></div>
                <div class="form-group"><label>Valor</label><input type="number" step="0.01" id="t-amount" class="form-control" required></div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="t-category" class="form-control">
                        <option value="Moradia">üè† Moradia</option>
                        <option value="Alimenta√ß√£o">üçî Alimenta√ß√£o</option>
                        <option value="Transporte">üöó Transporte</option>
                        <option value="Lazer">üéâ Lazer</option>
                        <option value="Sa√∫de">üíä Sa√∫de</option>
                        <option value="Sal√°rio">üí∞ Sal√°rio</option>
                        <option value="Outros">üì¶ Outros</option>
                    </select>
                </div>
                <div class="form-group"><label>Data</label><input type="date" id="t-date" class="form-control" required></div>
                <div class="form-group" id="card-select-group">
                    <label>Pagar com Cart√£o?</label>
                    <select id="t-card" class="form-control"><option value="">Dinheiro / D√©bito</option></select>
                </div>
                <div style="text-align: right; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-outline" onclick="closeModals()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Card Modal -->
    <div class="modal-overlay" id="card-modal">
        <div class="modal">
            <div class="flex-between">
                <h3 id="c-modal-title">Novo Cart√£o</h3>
                <button class="btn btn-sm btn-outline" onclick="closeModals()">‚úï</button>
            </div>
            <form id="card-form">
                <input type="hidden" id="c-id">
                <div class="form-group"><label>Nome</label><input type="text" id="c-name" class="form-control" required></div>
                <div class="form-group"><label>Limite</label><input type="number" step="0.01" id="c-limit" class="form-control" required></div>
                <div class="form-group">
                    <label>Cor</label>
                    <select id="c-color" class="form-control">
                        <option value="#667eea">Roxo</option><option value="#48bb78">Verde</option><option value="#ed8936">Laranja</option><option value="#f56565">Vermelho</option><option value="#4299e1">Azul</option><option value="#2d3748">Preto</option>
                    </select>
                </div>
                <div style="text-align: right; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-outline" onclick="closeModals()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="toast-container" id="toast-area"></div>

    <!-- FIREBASE SDKS -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // --- CONFIGURA√á√ÉO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBHoW1rE9xVAiqOk1ro1SgiI4Rlq4vUx38",
            authDomain: "financas2-c616f.firebaseapp.com",
            projectId: "financas2-c616f",
            storageBucket: "financas2-c616f.firebasestorage.app",
            messagingSenderId: "1029379063635",
            appId: "1:1029379063635:web:b8ec7c6877e9b512686ba6"
        };

        try {
            firebase.initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Erro ao iniciar Firebase.", e);
            alert("Erro de configura√ß√£o do Firebase. Verifique as chaves.");
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- ESTADO LOCAL ---
        let state = {
            transactions: [],
            cards: [],
            logs: [],
            user: null
        };

        // --- AUTH LOGIC ---
        let authMode = 'login';

        function switchAuthTab(mode) {
            authMode = mode;
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${mode}`).classList.add('active');
            document.querySelector('#auth-form button').textContent = mode === 'login' ? 'Entrar' : 'Criar Conta';
            document.getElementById('auth-error').textContent = '';
        }

        function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const errorDiv = document.getElementById('auth-error');

            if (authMode === 'register') {
                auth.createUserWithEmailAndPassword(email, pass)
                    .then(() => {})
                    .catch(err => errorDiv.textContent = traduzirErroFirebase(err.code));
            } else {
                auth.signInWithEmailAndPassword(email, pass)
                    .then(() => {})
                    .catch(err => errorDiv.textContent = traduzirErroFirebase(err.code));
            }
        }

        function logout() {
            auth.signOut();
        }

        function traduzirErroFirebase(code) {
            const map = {
                'auth/invalid-email': 'Email inv√°lido.', 'auth/user-disabled': 'Usu√°rio desabilitado.', 'auth/user-not-found': 'Usu√°rio n√£o encontrado.', 'auth/wrong-password': 'Senha incorreta.', 'auth/email-already-in-use': 'Email j√° est√° em uso.', 'auth/weak-password': 'A senha √© muito fraca.', 'auth/invalid-credential': 'Credenciais inv√°lidas.'
            };
            return map[code] || code;
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                state.user = user;
                document.getElementById('auth-overlay').classList.remove('open');
                document.getElementById('app-sidebar').classList.remove('hidden');
                document.getElementById('app-main').classList.remove('hidden');
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('display-email').textContent = user.email;
                loadDataFromFirebase();
            } else {
                state.user = null;
                document.getElementById('auth-overlay').classList.add('open');
                document.getElementById('app-sidebar').classList.add('hidden');
                document.getElementById('app-main').classList.add('hidden');
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        });

        // --- FIREBASE DATA LOGIC ---
        function loadDataFromFirebase() {
            db.collection('transactions').orderBy('date', 'desc').onSnapshot(snapshot => {
                state.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI();
            }, err => console.error(err));

            db.collection('cards').onSnapshot(snapshot => {
                state.cards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI();
            }, err => console.error(err));

            db.collection('logs').orderBy('timestamp', 'desc').limit(50).onSnapshot(snapshot => {
                state.logs = snapshot.docs.map(doc => doc.data());
                renderLogs();
            }, err => console.error(err));
        }

        async function saveTransactionToFirebase(tData, id = null) {
            try {
                if (id) {
                    await db.collection('transactions').doc(id).update(tData);
                    addLog('edit', `Editou: ${tData.desc}`);
                    showToast('Atualizado!', 'success');
                } else {
                    await db.collection('transactions').add({ ...tData, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                    addLog('add', `Adicionou: ${tData.desc}`);
                    showToast('Salvo!', 'success');
                }
            } catch (e) { showToast('Erro ao salvar', 'error'); }
        }

        async function deleteTransactionFromFirebase(id) {
            try {
                const t = state.transactions.find(x => x.id === id);
                await db.collection('transactions').doc(id).delete();
                addLog('delete', `Excluiu: ${t ? t.desc : ''}`);
                showToast('Removido.', 'info');
            } catch (e) { showToast('Erro ao excluir', 'error'); }
        }

        async function saveCardToFirebase(cData, id = null) {
            try {
                if (id) {
                    await db.collection('cards').doc(id).update(cData);
                    addLog('edit', `Editou cart√£o: ${cData.name}`);
                    showToast('Cart√£o atualizado!', 'success');
                } else {
                    await db.collection('cards').add(cData);
                    addLog('add', `Criou cart√£o: ${cData.name}`);
                    showToast('Cart√£o criado!', 'success');
                }
            } catch (e) { showToast('Erro ao salvar cart√£o', 'error'); }
        }

        async function deleteCardFromFirebase(id) {
            const hasTrans = state.transactions.some(t => t.cardId == id);
            if (hasTrans) return showToast('Cart√£o em uso. N√£o pode excluir.', 'error');
            try {
                const c = state.cards.find(x => x.id === id);
                await db.collection('cards').doc(id).delete();
                addLog('delete', `Excluiu cart√£o: ${c ? c.name : ''}`);
                showToast('Cart√£o removido.', 'info');
            } catch (e) { showToast('Erro ao excluir', 'error'); }
        }

        function addLog(type, message) {
            db.collection('logs').add({
                type, message, user: state.user.email,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        function clearLogs() {
            if(!confirm("Limpar logs?")) return;
            alert("Para limpar logs de forma segura, acesse o console do Firebase e apague a cole√ß√£o 'logs'.");
        }

        // --- UI RENDERING ---
        function updateUI() {
            renderSummary();
            renderTransactionsList();
            renderCards();
            updateCardSelect();
        }

        function renderSummary() {
            const income = state.transactions.filter(t => t.type === 'income').reduce((acc, t) => acc + parseFloat(t.amount), 0);
            const expense = state.transactions.filter(t => t.type === 'expense').reduce((acc, t) => acc + parseFloat(t.amount), 0);
            document.getElementById('total-income').textContent = formatCurrency(income);
            document.getElementById('total-expense').textContent = formatCurrency(expense);
            document.getElementById('total-balance').textContent = formatCurrency(income - expense);
        }

        function renderTransactionsList() {
            const list = document.getElementById('all-transactions-list');
            const recent = document.getElementById('recent-transactions-list');
            const search = document.getElementById('search-input').value.toLowerCase();
            const filtered = state.transactions.filter(t => t.desc.toLowerCase().includes(search) || t.category.toLowerCase().includes(search));

            const generateHTML = (t, showActions = false) => {
                const isExpense = t.type === 'expense';
                const colorClass = isExpense ? 'text-danger' : 'text-success';
                const sign = isExpense ? '-' : '+';
                let cardTag = '';
                if (t.cardId) {
                    const card = state.cards.find(c => c.id == t.cardId);
                    if (card) cardTag = `<span class="tag" style="border:1px solid ${card.color}; color:${card.color}">${card.name}</span>`;
                }
                const actionBtns = showActions ? `
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline" onclick="openTransactionModal('${t.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTransactionFromFirebase('${t.id}')">üóë</button>
                    </div>` : '';

                return `
                <div class="list-item">
                    <div class="item-info">
                        <h4>${t.desc} ${cardTag}</h4>
                        <p>${formatDate(t.date)} ‚Ä¢ ${t.category}</p>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <div class="item-amount ${colorClass}" style="margin-right: 15px;">${sign} ${formatCurrency(t.amount, false)}</div>
                        ${actionBtns}
                    </div>
                </div>`;
            };

            list.innerHTML = filtered.length ? filtered.map(t => generateHTML(t, true)).join('') : '<div class="empty-state">Nada encontrado.</div>';
            recent.innerHTML = state.transactions.slice(0, 5).map(t => generateHTML(t, false)).join('');
        }

        function renderCards() {
            const container = document.getElementById('cards-container');
            if (state.cards.length === 0) { container.innerHTML = '<div class="empty-state">Sem cart√µes.</div>'; return; }

            container.innerHTML = state.cards.map(card => {
                const spent = state.transactions.filter(t => t.cardId == card.id && t.type === 'expense').reduce((acc, t) => acc + parseFloat(t.amount), 0);
                const percent = Math.min((spent / card.limit) * 100, 100);
                return `
                <div class="credit-card-ui" style="background: linear-gradient(135deg, ${card.color} 0%, #2d3748 100%);">
                    <div class="flex-between" style="margin:0; color:white;">
                        <div class="card-name">${card.name}</div>
                        <div>
                            <button onclick="openCardModal('${card.id}')" style="background:none; border:none; color:white; cursor:pointer; margin-right:10px;">‚úèÔ∏è</button>
                            <button onclick="deleteCardFromFirebase('${card.id}')" style="background:none; border:none; color:white; cursor:pointer;">üóë</button>
                        </div>
                    </div>
                    <div style="font-size: 2rem; letter-spacing: 2px; margin: 1rem 0;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
                    <div class="card-limit-info">
                        <div class="flex-between" style="margin:0; font-size: 0.8rem; color: rgba(255,255,255,0.8);">
                            <span>Gasto: ${formatCurrency(spent, false)}</span>
                            <span>Limite: ${formatCurrency(card.limit, false)}</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" style="width: ${percent}%"></div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function updateCardSelect() {
            const select = document.getElementById('t-card');
            select.innerHTML = '<option value="">Dinheiro / D√©bito</option>';
            state.cards.forEach(c => { select.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
        }

        function renderLogs() {
            const container = document.getElementById('logs-list');
            if (state.logs.length === 0) { container.innerHTML = '<div class="empty-state">Sem logs.</div>'; return; }
            
            container.innerHTML = state.logs.map(log => {
                let dateStr = '';
                if (log.timestamp && log.timestamp.toDate) {
                    dateStr = log.timestamp.toDate().toLocaleString('pt-BR');
                } else if (log.timestamp) {
                    dateStr = new Date(log.timestamp).toLocaleString('pt-BR');
                }

                const color = log.type === 'add' ? '#48bb78' : (log.type === 'delete' ? '#f56565' : '#ed8936');
                return `
                <div style="position: relative; padding-left: 20px; margin-bottom: 10px;">
                    <div style="position: absolute; left: -26px; top: 5px; width: 10px; height: 10px; border-radius: 50%; background: ${color}; border: 2px solid white;"></div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">${dateStr} ‚Ä¢ <strong>${log.user}</strong></div>
                    <div style="font-size: 0.95rem;">${log.message}</div>
                </div>`;
            }).join('');
        }

        // --- INTERACTION HELPERS ---
        function showSection(id, navEl) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            navEl.classList.add('active');
            if(window.innerWidth <= 768) document.getElementById('app-sidebar').classList.remove('open');
        }

        function toggleSidebar() {
            document.getElementById('app-sidebar').classList.toggle('open');
        }

        function selectType(type, el) {
            document.querySelectorAll('.radio-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('card-select-group').style.display = type === 'expense' ? 'block' : 'none';
            if(type === 'income') document.getElementById('t-card').value = "";
        }

        function closeModals() {
            document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('open'));
            document.getElementById('transaction-form').reset();
            document.getElementById('card-form').reset();
            document.getElementById('t-id').value = "";
            document.getElementById('c-id').value = "";
            document.getElementById('t-date').valueAsDate = new Date();
            selectType('income', document.getElementById('opt-income'));
        }

        function openTransactionModal(id = null) {
            document.getElementById('transaction-modal').classList.add('open');
            document.getElementById('t-date').valueAsDate = new Date();
            if (id) {
                const t = state.transactions.find(x => x.id === id);
                if(!t) return;
                document.getElementById('t-modal-title').textContent = "Editar Transa√ß√£o";
                document.getElementById('t-id').value = t.id;
                document.getElementById('t-desc').value = t.desc;
                document.getElementById('t-amount').value = t.amount;
                document.getElementById('t-category').value = t.category;
                document.getElementById('t-date').value = t.date;
                document.getElementById('t-card').value = t.cardId || "";
                selectType(t.type, document.getElementById(t.type === 'income' ? 'opt-income' : 'opt-expense'));
            } else {
                document.getElementById('t-modal-title').textContent = "Nova Transa√ß√£o";
                document.getElementById('t-id').value = "";
                selectType('income', document.getElementById('opt-income'));
            }
            updateCardSelect();
        }

        function openCardModal(id = null) {
            document.getElementById('card-modal').classList.add('open');
            if(id) {
                const c = state.cards.find(x => x.id === id);
                document.getElementById('c-modal-title').textContent = "Editar Cart√£o";
                document.getElementById('c-id').value = c.id;
                document.getElementById('c-name').value = c.name;
                document.getElementById('c-limit').value = c.limit;
                document.getElementById('c-color').value = c.color;
            } else {
                document.getElementById('c-modal-title').textContent = "Novo Cart√£o";
                document.getElementById('c-id').value = "";
            }
        }

        document.getElementById('transaction-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('t-id').value;
            const type = document.querySelector('.radio-option.selected').id === 'opt-income' ? 'income' : 'expense';
            const cardId = document.getElementById('t-card').value;
            const tData = {
                type, desc: document.getElementById('t-desc').value,
                amount: parseFloat(document.getElementById('t-amount').value),
                category: document.getElementById('t-category').value,
                date: document.getElementById('t-date').value,
                cardId: cardId || null
            };
            saveTransactionToFirebase(tData, id || null);
            closeModals();
        });

        document.getElementById('card-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('c-id').value;
            const cData = {
                name: document.getElementById('c-name').value,
                limit: parseFloat(document.getElementById('c-limit').value),
                color: document.getElementById('c-color').value
            };
            saveCardToFirebase(cData, id || null);
            closeModals();
        });

        function formatCurrency(val, withSymbol = true) {
            const formatted = val.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            return withSymbol ? `R$ ${formatted}` : formatted;
        }
        function formatDate(isoDate) {
            if(!isoDate) return '';
            const [y, m, d] = isoDate.split('-');
            return `${d}/${m}/${y}`;
        }
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-area');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeftColor = type === 'success' ? '#48bb78' : (type === 'error' ? '#f56565' : '#5a67d8');
            toast.innerHTML = `<span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = 0; setTimeout(() => toast.remove(), 300); }, 3000);
        }
    </script>
</body>
</html>

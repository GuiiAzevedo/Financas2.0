<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#5a67d8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Finan√ßas Fam√≠lia Pro</title>

    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --bg-body: #f4f6f8; --bg-card: #ffffff; --text-primary: #2d3748; --text-secondary: #718096; --primary: #5a67d8; --primary-hover: #4c51bf; --success: #48bb78; --danger: #f56565; --warning: #ed8936; --border: #e2e8f0; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); --radius: 12px; --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        [data-theme="dark"] { --bg-body: #1a202c; --bg-card: #2d3748; --text-primary: #f7fafc; --text-secondary: #a0aec0; --border: #4a5568; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4); }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: var(--font-family); background-color: var(--bg-body); color: var(--text-primary); line-height: 1.5; height: 100vh; display: flex; overflow: hidden; transition: background 0.3s, color 0.3s; }
        .sidebar { width: 260px; background: var(--bg-card); border-right: 1px solid var(--border); padding: 2rem 1.5rem; display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.3s ease, background 0.3s; z-index: 100; }
        .main-content { flex: 1; overflow-y: auto; padding: 2rem; position: relative; scroll-behavior: smooth; }
        .brand { font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-bottom: 2rem; display: flex; align-items: center; gap: 10px; }
        .nav-links { list-style: none; display: flex; flex-direction: column; gap: 0.5rem; }
        .nav-item { padding: 0.75rem 1rem; border-radius: var(--radius); cursor: pointer; transition: all 0.2s; color: var(--text-secondary); font-weight: 500; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { background-color: var(--bg-body); color: var(--primary); }
        .nav-item.active { background-color: var(--primary); color: white; }
        .btn { padding: 0.75rem 1.5rem; border-radius: var(--radius); border: none; cursor: pointer; font-weight: 600; transition: transform 0.1s, opacity 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); }
        .btn-sm { padding: 0.4rem 0.6rem; font-size: 0.85rem; margin-left: 5px; }
        .card { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1.5rem; margin-bottom: 1.5rem; transition: background 0.3s; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card h3 { font-size: 0.875rem; color: var(--text-secondary); font-weight: 500; margin-bottom: 0.5rem; }
        .stat-card .value { font-size: 1.75rem; font-weight: 700; }
        .text-success { color: var(--success); } .text-danger { color: var(--danger); } .text-primary { color: var(--primary); }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border); background: var(--bg-card); }
        .item-info h4 { font-size: 1rem; margin-bottom: 0.2rem; }
        .item-info p { font-size: 0.85rem; color: var(--text-secondary); }
        .tag { font-size: 0.75rem; padding: 2px 8px; border-radius: 12px; background: var(--bg-body); color: var(--text-secondary); margin-left: 8px; }
        .action-buttons { display: flex; gap: 5px; }
        .credit-card-ui { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 16px; margin-bottom: 1rem; position: relative; overflow: hidden; box-shadow: var(--shadow); }
        .progress-bar-bg { background: rgba(255,255,255,0.3); height: 8px; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .progress-bar-fill { background: white; height: 100%; border-radius: 4px; width: 0%; transition: width 0.5s ease; }
        #auth-overlay, #group-overlay { background: var(--bg-body); z-index: 2000; display: flex; align-items: center; justify-content: center; position: fixed; top:0; left:0; width:100%; height:100%; }
        .auth-box, .group-box { background: var(--bg-card); padding: 2.5rem; border-radius: var(--radius); box-shadow: var(--shadow); width: 100%; max-width: 400px; text-align: center; }
        .auth-tabs { display: flex; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); }
        .auth-tab { flex: 1; padding: 0.5rem; cursor: pointer; color: var(--text-secondary); }
        .auth-tab.active { border-bottom: 2px solid var(--primary); color: var(--primary); font-weight: bold; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal { background: var(--bg-card); width: 100%; max-width: 500px; border-radius: var(--radius); padding: 2rem; transform: translateY(20px); transition: transform 0.3s; max-height: 90vh; overflow-y: auto;}
        .modal-overlay.open .modal { transform: translateY(0); }
        .form-group { margin-bottom: 1rem; text-align: left; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500; }
        .form-control { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 1rem; background: var(--bg-body); color: var(--text-primary); }
        .radio-group { display: flex; gap: 1rem; }
        .radio-option { flex: 1; padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; text-align: center; }
        .radio-option.selected { border-color: var(--primary); background: var(--primary); color: white; }
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--bg-card); border-left: 4px solid var(--primary); padding: 1rem; border-radius: 4px; box-shadow: var(--shadow); min-width: 250px; animation: slideIn 0.3s ease; color: var(--text-primary); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .hidden { display: none !important; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .empty-state { text-align: center; padding: 3rem; color: var(--text-secondary); }
        #loading-overlay { position: fixed; inset: 0; background: var(--bg-body); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--bg-card); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .mobile-menu-btn { display: none; position: fixed; top: 15px; right: 15px; z-index: 200; background: var(--bg-card); border-radius: 50%; width: 40px; height: 40px; box-shadow: var(--shadow); border: 1px solid var(--border); font-size: 1.2rem; align-items: center; justify-content: center; cursor: pointer; color: var(--text-primary); }
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; min-height: 100vh; }
            .sidebar { position: fixed; height: 100%; left: -260px; box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
            .sidebar.open { transform: translateX(260px); left: -260px; }
            .mobile-menu-btn { display: flex; }
            .nav-links { flex-direction: column; overflow-x: visible; padding-bottom: 5px; }
            .main-content { padding: 5rem 1rem 1rem 1rem; }
            .summary-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- LOADING -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; color: var(--text-secondary);">Carregando...</p>
    </div>

    <!-- MOBILE MENU BUTTON -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <!-- AUTH SCREEN -->
    <div id="auth-overlay" class="modal-overlay open">
        <div class="auth-box">
            <img src="icon.png" style="width: 80px; height: 80px; border-radius: 20px; margin-bottom: 1rem; box-shadow: var(--shadow);" alt="Logo">
            <h1 style="color: var(--primary); margin-bottom: 0.5rem;">Finan√ßas Pro</h1>
            
            <div id="firebase-status" style="font-size: 0.8rem; color: var(--success); margin-bottom: 0.5rem;">‚úì Firebase Conectado</div>
            
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Gerenciamento familiar</p>
            
            <div class="auth-tabs">
                <div class="auth-tab active" id="tab-login" onclick="switchAuthTab('login')">Entrar</div>
                <div class="auth-tab" id="tab-register" onclick="switchAuthTab('register')">Criar Conta</div>
            </div>

            <form id="auth-form" onsubmit="handleAuth(event)">
                <div class="form-group">
                    <input type="email" id="auth-email" class="form-control" placeholder="Seu Email" required autocomplete="email">
                </div>
                <div class="form-group">
                    <input type="password" id="auth-pass" class="form-control" placeholder="Senha" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Acessar</button>
            </form>

            <!-- DEBUG LOG (VISUAL) -->
            <div id="debug-log" style="background: #2d3748; color: #fff; font-family: monospace; padding: 10px; font-size: 0.75rem; text-align: left; border-radius: 4px; min-height: 60px; max-height: 100px; overflow-y: auto; white-space: pre-wrap;">
> Pronto...
            </div>

            <button type="button" onclick="handleResetPassword()" style="margin-top: 15px; background:none; border:none; color: var(--text-secondary); font-size: 0.85rem; cursor: pointer; text-decoration: underline;">Esqueci minha senha</button>

            <div id="auth-error" style="color: var(--danger); margin-top: 10px; font-size: 0.9rem;"></div>
        </div>
    </div>

    <!-- GROUP SETUP SCREEN -->
    <div id="group-overlay" class="modal-overlay">
        <div class="group-box">
            <h2 style="color: var(--primary); margin-bottom: 1rem;">Configurar Fam√≠lia</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.9rem;">Crie um novo grupo familiar ou entre em um existente para come√ßar.</p>
            <div class="form-group" style="text-align: left;">
                <label>Nome do Grupo (Ex: Fam√≠lia Azevedo)</label>
                <input type="text" id="group-name-input" class="form-control" placeholder="Nome">
            </div>
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;" onclick="createGroup()">Criar Novo Grupo</button>
            <div style="border-top: 1px solid var(--border); margin: 1rem 0;"></div>
            <div class="form-group" style="text-align: left;">
                <label>Ou entre com o C√≥digo do Grupo</label>
                <input type="text" id="group-code-input" class="form-control" placeholder="C√≥digo do Grupo (ID)">
            </div>
            <button class="btn btn-outline" style="width: 100%;" onclick="joinGroup()">Entrar no Grupo</button>
        </div>
    </div>

    <!-- APP LAYOUT -->
    <nav class="sidebar hidden" id="app-sidebar">
        <div>
            <div class="brand">Finan√ßas</div>
            <div style="background: var(--bg-body); padding: 10px; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--border);">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">GRUPO ATUAL</div>
                        <div id="display-group-name" style="font-weight: bold; color: var(--primary);">...</div>
                        <div id="display-group-id" style="font-size: 0.7rem; color: var(--text-secondary); font-family: monospace;">...</div>
                    </div>
                    <button onclick="leaveGroup()" title="Sair do Grupo" style="background:none; border:none; color: var(--danger); cursor: pointer; font-size: 1.2rem; line-height: 1;">‚úï</button>
                </div>
                <div style="margin-top: 5px; text-align: right;">
                    <button onclick="leaveGroup()" style="background:none; border:none; color: var(--danger); font-size: 0.75rem; cursor: pointer; text-decoration: underline;">Sair do Grupo</button>
                </div>
            </div>
            <div style="background: var(--bg-body); padding: 10px; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid var(--border);">
                <div style="font-weight:bold; color:var(--text-primary);" id="display-email"></div>
                <div style="font-size:0.75rem; opacity:0.7;">Logado</div>
            </div>
            <ul class="nav-links">
                <li class="nav-item active" onclick="showSection('dashboard', this)"><span>üìä</span> Dashboard</li>
                <li class="nav-item" onclick="showSection('transactions', this)"><span>üí∏</span> Transa√ß√µes</li>
                <li class="nav-item" onclick="showSection('cards', this)"><span>üí≥</span> Cart√µes</li>
                <li class="nav-item" onclick="showSection('logs', this)"><span>üìú</span> Logs</li>
            </ul>
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn btn-outline btn-sm" onclick="toggleTheme()" id="theme-btn">üåô Modo Escuro</button>
            <button class="btn btn-outline btn-sm" onclick="logout()" style="color: var(--danger); border-color: var(--danger);">Sair</button>
        </div>
    </nav>

    <main class="main-content hidden" id="app-main">
        <section id="dashboard" class="view-section">
            <div class="flex-between">
                <h2>Dashboard</h2>
                <button class="btn btn-primary" onclick="openTransactionModal()">+ Nova</button>
            </div>
            <div class="summary-grid">
                <div class="card stat-card"><h3>Saldo Atual</h3><div class="value text-primary" id="total-balance">R$ 0,00</div></div>
                <div class="card stat-card"><h3>Entradas (M√™s)</h3><div class="value text-success" id="total-income">R$ 0,00</div></div>
                <div class="card stat-card"><h3>Sa√≠das (M√™s)</h3><div class="value text-danger" id="total-expense">R$ 0,00</div></div>
            </div>
            <div class="card">
                <h3>Fluxo Mensal (√öltimos 6 meses)</h3>
                <div id="monthly-chart-container" style="height: 250px; margin-top: 1rem;"></div>
            </div>
            <div class="card">
                <h3>√öltimas Transa√ß√µes</h3>
                <div id="recent-transactions-list" class="transaction-list"></div>
            </div>
        </section>

        <section id="transactions" class="view-section hidden">
            <div class="flex-between">
                <h2>Transa√ß√µes</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" onclick="exportPDF()">üìÑ PDF</button>
                    <button class="btn btn-primary" onclick="openTransactionModal()">+ Adicionar</button>
                </div>
            </div>
            <div class="card">
                <input type="text" id="search-input" class="form-control" placeholder="üîç Buscar..." onkeyup="renderTransactionsList()">
                <div id="all-transactions-list" class="transaction-list" style="margin-top: 1rem;"></div>
            </div>
        </section>

        <section id="cards" class="view-section hidden">
            <div class="flex-between">
                <h2>Meus Cart√µes</h2>
                <button class="btn btn-primary" onclick="openCardModal()">+ Novo Cart√£o</button>
            </div>
            <div id="cards-container" class="card-list"></div>
        </section>

        <section id="logs" class="view-section hidden">
            <div class="flex-between"><h2>Log de Auditoria</h2><button class="btn btn-outline btn-sm" onclick="clearLogs()">Limpar Logs</button></div>
            <div class="card">
                <div id="logs-list" style="display: flex; flex-direction: column; gap: 1rem; border-left: 2px solid var(--border); padding-left: 20px; margin-left: 10px;"></div>
            </div>
        </section>
    </main>

    <div class="modal-overlay" id="transaction-modal">
        <div class="modal">
            <div class="flex-between">
                <h3 id="t-modal-title">Nova Transa√ß√£o</h3>
                <button class="btn btn-sm btn-outline" onclick="closeModals()">‚úï</button>
            </div>
            <form id="transaction-form">
                <input type="hidden" id="t-id">
                <div class="form-group">
                    <label>Tipo</label>
                    <div class="radio-group">
                        <div class="radio-option selected" onclick="selectType('income', this)" id="opt-income">Entrada</div>
                        <div class="radio-option" onclick="selectType('expense', this)" id="opt-expense">Sa√≠da</div>
                    </div>
                </div>
                <div class="form-group"><label>Descri√ß√£o</label><input type="text" id="t-desc" class="form-control" required></div>
                <div class="form-group"><label>Valor</label><input type="number" step="0.01" id="t-amount" class="form-control" required></div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="t-category" class="form-control">
                        <option value="Moradia">üè† Moradia</option>
                        <option value="Alimenta√ß√£o">üçî Alimenta√ß√£o</option>
                        <option value="Transporte">üöó Transporte</option>
                        <option value="Lazer">üéâ Lazer</option>
                        <option value="Sa√∫de">üíä Sa√∫de</option>
                        <option value="Sal√°rio">üí∞ Sal√°rio</option>
                        <option value="Outros">üì¶ Outros</option>
                    </select>
                </div>
                <div class="form-group"><label>Data</label><input type="date" id="t-date" class="form-control" required></div>
                <div class="form-group" id="card-select-group">
                    <label>Pagar com Cart√£o?</label>
                    <select id="t-card" class="form-control"><option value="">Dinheiro / D√©bito</option></select>
                </div>
                <div style="text-align: right; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-outline" onclick="closeModals()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="card-modal">
        <div class="modal">
            <div class="flex-between">
                <h3 id="c-modal-title">Novo Cart√£o</h3>
                <button class="btn btn-sm btn-outline" onclick="closeModals()">‚úï</button>
            </div>
            <form id="card-form">
                <input type="hidden" id="c-id">
                <div class="form-group"><label>Nome</label><input type="text" id="c-name" class="form-control" required></div>
                <div class="form-group"><label>Limite</label><input type="number" step="0.01" id="c-limit" class="form-control" required></div>
                <div class="form-group">
                    <label>Cor</label>
                    <select id="c-color" class="form-control">
                        <option value="#667eea">Roxo</option><option value="#48bb78">Verde</option><option value="#ed8936">Laranja</option><option value="#f56565">Vermelho</option><option value="#4299e1">Azul</option><option value="#2d3748">Preto</option>
                    </select>
                </div>
                <div style="text-align: right; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-outline" onclick="closeModals()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="toast-container" id="toast-area"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        console.log("Scripts iniciados.");
        const firebaseConfig = {
            apiKey: "AIzaSyBHoW1rE9xVAiqOk1ro1SgiI4Rlq4vUx38",
            authDomain: " "financas2-c616f.firebaseapp.com",
            projectId: "financas2-c616f",
            storageBucket: "financas2-c616f.firebasestorage.app",
            messagingSenderId: "1029379063635",
            appId: "1:1029379063635:web:b8ec7c6877e9b512686ba6"
        };

        let auth, db;
        let authMode = 'login';
        let debugLogDiv = document.getElementById('debug-log');

        function addDebugLog(msg) {
            const time = new Date().toLocaleTimeString();
            debugLogDiv.innerHTML += `[${time}] ${msg}\n`;
            debugLogDiv.scrollTop = debugLogDiv.scrollHeight;
        }

        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            document.getElementById('firebase-status').textContent = "‚úì Firebase Conectado";
            document.getElementById('firebase-status').style.color = "var(--success)";
            console.log("Firebase OK.");
        } catch (e) { 
            console.error("Erro Firebase:", e);
            document.getElementById('firebase-status').textContent = "X Erro no Firebase";
            document.getElementById('firebase-status').style.color = "var(--danger)";
            alert("Erro cr√≠tico no Firebase: " + e.message);
        }

        let state = { transactions: [], cards: [], logs: [], user: null, currentGroupId: null };

        window.handleResetPassword = function() {
            const email = prompt("Digite seu email para receber o link de redefini√ß√£o:");
            if(email) {
                auth.sendPasswordResetEmail(email)
                    .then(() => {
                        alert("üìß Email de redefini√ß√£o enviado!\n\nVerifique sua caixa de entrada e siga as instru√ß√µes.");
                        switchAuthTab('login');
                        document.getElementById('auth-email').value = email;
                    })
                    .catch((error) => {
                        alert("Erro ao enviar email: " + error.message);
                    });
            }
        };

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            updateThemeBtn(savedTheme);
        }

        function toggleTheme() {
            const current = document.body.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateThemeBtn(next);
        }

        function updateThemeBtn(theme) {
            document.getElementById('theme-btn').textContent = theme === 'dark' ? '‚òÄÔ∏è Modo Claro' : 'üåô Modo Escuro';
        }

        function switchAuthTab(mode) {
            authMode = mode;
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${mode}`).classList.add('active');
            document.querySelector('#auth-form button').textContent = mode === 'login' ? 'Entrar' : 'Criar Conta';
            document.getElementById('auth-error').textContent = '';
            debugLogDiv.innerHTML = ''; // Limpa log ao trocar de aba
        }

        function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const errorDiv = document.getElementById('auth-error');
            const btn = document.querySelector('#auth-form button');

            if (!auth) return alert("Erro: Objeto Auth n√£o encontrado.");

            btn.textContent = "Processando...";
            btn.disabled = true;
            errorDiv.textContent = "";
            debugLog(`1. Iniciando requisi√ß√£o para: ${email}`);

            // TIMEOUT AGRESSIVO (5s)
            const timeoutId = setTimeout(() => {
                debugLog(`\nTIMEOUT! A requisi√ß√£o travou.\n\nDIAGN√ìSTICO: Se voc√™ est√° vendo essa mensagem e o status do Firebase est√° verde, seu NAVEGADOR OU FIREWALL est√° bloqueando a resposta do login (CORS ou Bloqueio de DNS).\n\nSOLU√á√ÉO:\n1. Use o link do GitHub (HTTPS).\n2. Desative AdBlocker.\n3. Tente na sua internet m√≥vel (n√£o Wi-Fi de escrit√≥rio).`);
                btn.textContent = authMode === 'login' ? 'Acessar' : 'Criar Conta';
                btn.disabled = false;
            }, 5000);

            debugLog("2. Chamando m√©todo Firebase...");

            let authPromise = authMode === 'register' 
                ? auth.createUserWithEmailAndPassword(email, pass) 
                : auth.signInWithEmailAndPassword(email, pass);

            debugLog("3. Promise criada. Aguardando callback...");

            authPromise
                .then((user) => {
                    debugLog(`4. SUCESSO! Login Retornou usu√°rio: ${user.email}`);
                    clearTimeout(timeoutId);
                    // O listener vai cuidar do resto
                })
                .catch(err => {
                    debugLog(`5. ERRO NO LOGIN: ${err.code} - ${err.message}`);
                    clearTimeout(timeoutId);
                    errorDiv.textContent = err.message;
                    btn.textContent = authMode === 'login' ? 'Acessar' : 'Criar Conta';
                    btn.disabled = false;
                });
        }

        function logout() { if(auth) auth.signOut(); }

        if(auth) {
            auth.onAuthStateChanged(user => {
                if (user) {
                    state.user = user;
                    document.getElementById('display-email').textContent = user.email;
                    checkUserGroup(user.uid);
                } else {
                    state.user = null; state.currentGroupId = null;
                    document.getElementById('auth-overlay').classList.add('open');
                    document.getElementById('group-overlay').classList.remove('open');
                    document.getElementById('app-sidebar').classList.add('hidden');
                    document.getElementById('app-main').classList.add('hidden');
                    document.getElementById('loading-overlay').classList.add('hidden');
                }
            });
        }

        async function checkUserGroup(uid) {
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists && userDoc.data().groupId) {
                    state.currentGroupId = userDoc.data().groupId;
                    loadApp();
                } else {
                    document.getElementById('auth-overlay').classList.remove('open');
                    document.getElementById('group-overlay').classList.add('open');
                    document.getElementById('loading-overlay').classList.add('hidden');
                }
            } catch (e) {
                console.error(e);
                alert("Erro ao verificar grupo: " + e.message);
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        async function createGroup() {
            const name = document.getElementById('group-name-input').value;
            if(!name) return alert("Digite um nome");
            try {
                const groupRef = await db.collection('groups').add({ name: name, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                await db.collection('users').doc(state.user.uid).set({ groupId: groupRef.id }, { merge: true });
                state.currentGroupId = groupRef.id;
                showToast(`Grupo "${name}" criado!`, 'success');
                document.getElementById('group-overlay').classList.remove('open');
                loadApp();
            } catch (e) { alert("Erro ao criar grupo: " + e.message); }
        }

        async function joinGroup() {
            const code = document.getElementById('group-code-input').value.trim();
            if(!code) return alert("Digite o c√≥digo");
            try {
                const groupDoc = await db.collection('groups').doc(code).get();
                if (groupDoc.exists) {
                    await db.collection('users').doc(state.user.uid).set({ groupId: code }, { merge: true });
                    state.currentGroupId = code;
                    showToast(`Entrou no grupo: ${groupDoc.data().name}`, 'success');
                    document.getElementById('group-overlay').classList.remove('open');
                    loadApp();
                } else { alert("C√≥digo inv√°lido."); }
            } catch (e) { alert("Erro ao entrar: " + e.message); }
        }

        async function leaveGroup() {
            if (!confirm("Sair do grupo?")) return;
            try {
                await db.collection('users').doc(state.user.uid).update({ groupId: firebase.firestore.FieldValue.delete() });
                state.currentGroupId = null;
                document.getElementById('app-sidebar').classList.add('hidden');
                document.getElementById('app-main').classList.add('hidden');
                document.getElementById('group-overlay').classList.add('open');
                showToast('Voc√™ saiu.', 'info');
            } catch (e) { alert("Erro ao sair: " + e.message); }
        }

        function loadApp() {
            document.getElementById('app-sidebar').classList.remove('hidden');
            document.getElementById('app-main').classList.remove('hidden');
            document.getElementById('loading-overlay').classList.add('hidden');
            db.collection('groups').doc(state.currentGroupId).get().then(doc => {
                if(doc.exists) {
                    document.getElementById('display-group-name').textContent = doc.data().name;
                    document.getElementById('display-group-id').textContent = `ID: ${state.currentGroupId}`;
                }
            }).catch(e => console.error(e));
            loadGroupData();
        }

        function loadGroupData() {
            if(!state.currentGroupId) return;
            db.collection('groups').doc(state.currentGroupId).collection('transactions').orderBy('date', 'desc').onSnapshot(s => {
                state.transactions = s.docs.map(doc => ({ id: doc.id, ...doc.data() })); updateUI();
            }, err => { console.error(err); alert("Erro ao carregar transa√ß√µes."); });
            db.collection('groups').doc(state.currentGroupId).collection('cards').onSnapshot(s => {
                state.cards = s.docs.map(doc => ({ id: doc.id, ...doc.data() })); updateUI();
            }, err => console.error(err));
            db.collection('groups').doc(state.currentGroupId).collection('logs').orderBy('timestamp', 'desc').limit(50).onSnapshot(s => {
                state.logs = s.docs.map(doc => doc.data()); renderLogs();
            }, err => console.error(err));
        }

        // --- CRUD ---
        async function saveTransactionToFirebase(tData, id = null) {
            const col = db.collection('groups').doc(state.currentGroupId).collection('transactions');
            try {
                if (id) { await col.doc(id).update(tData); addLog('edit', `Editou: ${tData.desc}`); showToast('Atualizado!', 'success'); } 
                else { await col.add({ ...tData, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); addLog('add', `Adicionou: ${tData.desc}`); showToast('Salvo!', 'success'); }
            } catch (e) { showToast('Erro ao salvar: ' + e.message, 'error'); }
        }
        async function deleteTransactionFromFirebase(id) {
            try {
                const t = state.transactions.find(x => x.id === id);
                await db.collection('groups').doc(state.currentGroupId).collection('transactions').doc(id).delete();
                addLog('delete', `Excluiu: ${t ? t.desc : ''}`); showToast('Removido.', 'info');
            } catch (e) { showToast('Erro ao excluir', 'error'); }
        }
        async function saveCardToFirebase(cData, id = null) {
            const col = db.collection('groups').doc(state.currentGroupId).collection('cards');
            try {
                if (id) { await col.doc(id).update(cData); addLog('edit', `Editou cart√£o: ${cData.name}`); showToast('Atualizado!', 'success'); } 
                else { await col.add(cData); addLog('add', `Criou cart√£o: ${cData.name}`); showToast('Criado!', 'success'); }
            } catch (e) { showToast('Erro ao salvar cart√£o', 'error'); }
        }
        async function deleteCardFromFirebase(id) {
            if(state.transactions.some(t => t.cardId == id)) return showToast('Cart√£o em uso.', 'error');
            try {
                const c = state.cards.find(x => x.id === id);
                await db.collection('groups').doc(state.currentGroupId).collection('cards').doc(id).delete();
                addLog('delete', `Excluiu cart√£o: ${c ? c.name : ''}`); showToast('Removido.', 'info');
            } catch (e) { showToast('Erro ao excluir', 'error'); }
        }
        function addLog(type, message) {
            db.collection('groups').doc(state.currentGroupId).collection('logs').add({ type, message, user: state.user.email, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
        }
        function clearLogs() {
             if(!confirm("Limpar logs?")) return;
             db.collection('groups').doc(state.currentGroupId).collection('logs').get().then(s => { s.forEach(d => d.ref.delete()); });
        }

        // --- UI ---
        function updateUI() { renderSummary(); renderTransactionsList(); renderCards(); updateCardSelect(); renderMonthlyChart(); }
        function renderSummary() {
            const income = state.transactions.filter(t => t.type === 'income').reduce((acc, t) => acc + parseFloat(t.amount), 0);
            const expense = state.transactions.filter(t => t.type === 'expense').reduce((acc, t) => acc + parseFloat(t.amount), 0);
            document.getElementById('total-income').textContent = formatCurrency(income);
            document.getElementById('total-expense').textContent = formatCurrency(expense);
            document.getElementById('total-balance').textContent = formatCurrency(income - expense);
        }
        function renderTransactionsList() {
            const list = document.getElementById('all-transactions-list');
            const recent = document.getElementById('recent-transactions-list');
            const search = document.getElementById('search-input').value.toLowerCase();
            const filtered = state.transactions.filter(t => t.desc.toLowerCase().includes(search) || t.category.toLowerCase().includes(search));
            const generateHTML = (t, showActions = false) => {
                const isExpense = t.type === 'expense'; const colorClass = isExpense ? 'text-danger' : 'text-success'; const sign = isExpense ? '-' : '+';
                let cardTag = ''; if (t.cardId) { const card = state.cards.find(c => c.id == t.cardId); if (card) cardTag = `<span class="tag" style="border:1px solid ${card.color}; color:${card.color}">${card.name}</span>`; }
                const actionBtns = showActions ? `<div class="action-buttons"><button class="btn btn-sm btn-outline" onclick="openTransactionModal('${t.id}')">‚úèÔ∏è</button><button class="btn btn-sm btn-danger" onclick="deleteTransactionFromFirebase('${t.id}')">üóë</button></div>` : '';
                return `<div class="list-item"><div class="item-info"><h4>${t.desc} ${cardTag}</h4><p>${formatDate(t.date)} ‚Ä¢ ${t.category}</p></div><div style="display:flex; align-items:center;"><div class="item-amount ${colorClass}" style="margin-right: 15px;">${sign} ${formatCurrency(t.amount, false)}</div>${actionBtns}</div></div>`;
            };
            list.innerHTML = filtered.length ? filtered.map(t => generateHTML(t, true)).join('') : '<div class="empty-state">Nada encontrado.</div>';
            recent.innerHTML = state.transactions.slice(0, 5).map(t => generateHTML(t, false)).join('');
        }
        function renderCards() {
            const container = document.getElementById('cards-container');
            if (state.cards.length === 0) { container.innerHTML = '<div class="empty-state">Sem cart√µes.</div>'; return; }
            container.innerHTML = state.cards.map(card => {
                const spent = state.transactions.filter(t => t.cardId == card.id && t.type === 'expense').reduce((acc, t) => acc + parseFloat(t.amount), 0);
                const percent = Math.min((spent / card.limit) * 100, 100);
                return `<div class="credit-card-ui" style="background: linear-gradient(135deg, ${card.color} 0%, #2d3748 100%);"><div class="flex-between" style="margin:0; color:white;"><div class="card-name">${card.name}</div><div><button onclick="openCardModal('${card.id}')" style="background:none; border:none; color:white; cursor:pointer; margin-right:10px;">‚úèÔ∏è</button><button onclick="deleteCardFromFirebase('${card.id}')" style="background:none; border:none; color:white; cursor:pointer;">üóë</button></div></div><div style="font-size: 2rem; letter-spacing: 2px; margin: 1rem 0;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div><div class="card-limit-info"><div class="flex-between" style="margin:0; font-size: 0.8rem; color: rgba(255,255,255,0.8);"><span>Gasto: ${formatCurrency(spent, false)}</span><span>Limite: ${formatCurrency(card.limit, false)}</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width: ${percent}%"></div></div></div></div>`;
            }).join('');
        }
        function updateCardSelect() {
            const select = document.getElementById('t-card');
            select.innerHTML = '<option value="">Dinheiro / D√©bito</option>';
            state.cards.forEach(c => { select.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
        }
        function renderLogs() {
            const container = document.getElementById('logs-list');
            if (state.logs.length === 0) { container.innerHTML = '<div class="empty-state">Sem logs.</div>'; return; }
            container.innerHTML = state.logs.map(log => {
                let dateStr = log.timestamp && log.timestamp.toDate ? log.timestamp.toDate().toLocaleString('pt-BR') : '';
                const color = log.type === 'add' ? 'var(--success)' : (log.type === 'delete' ? 'var(--danger)' : 'var(--warning)');
                return `<div style="position: relative; padding-left: 20px; margin-bottom: 10px;"><div style="position: absolute; left: -26px; top: 5px; width: 10px; height: 10px; border-radius: 50%; background: ${color}; border: 2px solid var(--bg-card);"></div><div style="font-size: 0.8rem; color: var(--text-secondary);">${dateStr} ‚Ä¢ <strong>${log.user}</strong></div><div style="font-size: 0.95rem;">${log.message}</div></div>`;
            }).join('');
        }
        function renderMonthlyChart() {
            const container = document.getElementById('monthly-chart-container'); container.innerHTML = '';
            const months = [];
            for (let i = 5; i >= 0; i--) {
                const d = new Date(); d.setMonth(d.getMonth() - i);
                const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2, '0')}`;
                const label = d.toLocaleString('pt-BR', { month: 'short' });
                months.push({ key: k, label });
            }
            const data = months.map(m => {
                const inc = state.transactions.filter(t => t.type === 'income' && t.date.startsWith(m.key)).reduce((a,b) => a + parseFloat(b.amount), 0);
                const exp = state.transactions.filter(t => t.type === 'expense' && t.date.startsWith(m.key)).reduce((a,b) => a + parseFloat(b.amount), 0);
                return { ...m, inc, exp };
            });
            const maxVal = Math.max(...data.map(d => Math.max(d.inc, d.exp))) || 100;
            const w = 300, h = 150, barW = 15, gap = 20, chartH = 120;
            let svg = `<svg width="100%" height="100%" viewBox="0 0 ${w} ${h}">`;
            svg += `<rect x="10" y="0" width="10" height="10" fill="#48bb78"/> <text x="25" y="10" font-size="10" fill="var(--text-secondary)">Entradas</text>`;
            svg += `<rect x="80" y="0" width="10" height="10" fill="#f56565"/> <text x="95" y="10" font-size="10" fill="var(--text-secondary)">Sa√≠das</text>`;
            data.forEach((d, i) => {
                const x = 30 + i * (barW * 2 + gap);
                const hInc = (d.inc / maxVal) * chartH, hExp = (d.exp / maxVal) * chartH;
                const yInc = h - 20 - hInc, yExp = h - 20 - hExp;
                svg += `<rect x="${x}" y="${yInc}" width="${barW}" height="${hInc}" fill="#48bb78" rx="2"><title>Entradas: ${formatCurrency(d.inc)}</title></rect>`;
                svg += `<rect x="${x + barW}" y="${yExp}" width="${barW}" height="${hExp}" fill="#f56565" rx="2"><title>Sa√≠das: ${formatCurrency(d.exp)}</title></rect>`;
                svg += `<text x="${x + barW}" y="${h - 5}" font-size="10" text-anchor="middle" fill="var(--text-secondary)">${d.label}</text>`;
            });
            svg += `</svg>`;
            container.innerHTML = svg;
        }
        function exportPDF() {
            const element = document.getElementById('all-transactions-list');
            const opt = { margin: 1, filename: `Relatorio_Financas_${new Date().toISOString().split('T')[0]}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
            const clone = element.cloneNode(true);
            const wrapper = document.createElement('div');
            wrapper.style.padding = "20px"; wrapper.style.background = "white";
            wrapper.innerHTML = `<h2>Relat√≥rio de Transa√ß√µes</h2><p>Gerado em: ${new Date().toLocaleString()}</p>` + clone.innerHTML;
            html2pdf().set(opt).from(wrapper).save();
        }
        function showSection(id, navEl) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            navEl.classList.add('active');
            if(window.innerWidth <= 768) document.getElementById('app-sidebar').classList.remove('open');
        }
        function toggleSidebar() { document.getElementById('app-sidebar').classList.toggle('open'); }
        function selectType(type, el) {
            document.querySelectorAll('.radio-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('card-select-group').style.display = type === 'expense' ? 'block' : 'none';
            if(type === 'income') document.getElementById('t-card').value = "";
        }
        function closeModals() {
            document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('open'));
            document.getElementById('transaction-form').reset();
            document.getElementById('card-form').reset();
            document.getElementById('t-id').value = "";
            document.getElementById('c-id').value = "";
            document.getElementById('t-date').valueAsDate = new Date();
            selectType('income', document.getElementById('opt-income'));
        }
        function openTransactionModal(id = null) {
            document.getElementById('transaction-modal').classList.add('open');
            document.getElementById('t-date').valueAsDate = new Date();
            if (id) {
                const t = state.transactions.find(x => x.id === id);
                if(!t) return;
                document.getElementById('t-modal-title').textContent = "Editar Transa√ß√£o";
                document.getElementById('t-id').value = t.id;
                document.getElementById('t-desc').value = t.desc;
                document.getElementById('t-amount').value = t.amount;
                document.getElementById('t-category').value = t.category;
                document.getElementById('t-date').value = t.date;
                document.getElementById('t-card').value = t.cardId || "";
                selectType(t.type, document.getElementById(t.type === 'income' ? 'opt-income' : 'opt-expense'));
            } else {
                document.getElementById('t-modal-title').textContent = "Nova Transa√ß√£o";
                document.getElementById('t-id').value = "";
                selectType('income', document.getElementById('opt-income'));
            }
            updateCardSelect();
        }
        function openCardModal(id = null) {
            document.getElementById('card-modal').classList.add('open');
            if(id) {
                const c = state.cards.find(x => x.id === id);
                document.getElementById('c-modal-title').textContent = "Editar Cart√£o";
                document.getElementById('c-id').value = c.id;
                document.getElementById('c-name').value = c.name;
                document.getElementById('c-limit').value = c.limit;
                document.getElementById('c-color').value = c.color;
            } else {
                document.getElementById('c-modal-title').textContent = "Novo Cart√£o";
                document.getElementById('c-id').value = "";
            }
        }
        document.getElementById('transaction-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('t-id').value;
            const type = document.querySelector('.radio-option.selected').id === 'opt-income' ? 'income' : 'expense';
            const cardId = document.getElementById('t-card').value;
            const tData = { type, desc: document.getElementById('t-desc').value, amount: parseFloat(document.getElementById('t-amount').value), category: document.getElementById('t-category').value, date: document.getElementById('t-date').value, cardId: cardId || null };
            saveTransactionToFirebase(tData, id || null);
            closeModals();
        });
        document.getElementById('card-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('c-id').value;
            const cData = { name: document.getElementById('c-name').value, limit: parseFloat(document.getElementById('c-limit').value), color: document.getElementById('c-color').value };
            saveCardToFirebase(cData, id || null);
            closeModals();
        });
        function formatCurrency(val, withSymbol = true) {
            const formatted = val.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            return withSymbol ? `R$ ${formatted}` : formatted;
        }
        function formatDate(isoDate) {
            if(!isoDate) return '';
            const [y, m, d] = isoDate.split('-');
            return `${d}/${m}/${y}`;
        }
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-area');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeftColor = type === 'success' ? '#48bb78' : (type === 'error' ? '#f56565' : '#5a67d8');
            toast.innerHTML = `<span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = 0; setTimeout(() => toast.remove(), 300); }, 3000);
        }
        initTheme();
    </script>
</body>
</html>
